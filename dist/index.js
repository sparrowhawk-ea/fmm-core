(function(p,m){typeof exports=="object"&&typeof module!="undefined"?m(exports):typeof define=="function"&&define.amd?define(["exports"],m):(p=typeof globalThis!="undefined"?globalThis:p||self,m(p.Fmm={}))})(this,function(p){"use strict";class m{constructor(){this.minimaps=new Set}notifyMinimapOnUpdate(t,i){i?this.minimaps.add(t):this.minimaps.delete(t)}notifyMinimaps(){const t=new Set;this.minimaps.forEach(i=>i.takeSnapshot()||t.add(i)),t.forEach(i=>this.minimaps.delete(i))}}class R extends m{constructor(t,i){super();this.values=t,this.errors=i||{},this.values=t||{}}createStoreItem(t,i){for(const n of t.getStoreKeys(i))if(n&&n in this.values)return new z(i,n)}getError(t,i,n){const s=this.errors[i.key];return Array.isArray(s)?s.length?String(s[0]):"":s?String(s):""}getName(t,i){return i.key}getValue(t,i){return this.values[i.key]}isDisabled(t,i){return t.isDisabled(i.e)}update(t,i){this.errors=i||{},this.values=t||{},super.notifyMinimaps()}}class z{constructor(t,i){this.e=t,this.key=i}destructor(){}}const V={createFrameworkItem(e,t){return t.tagName==="INPUT"&&["checkbox","radio"].includes(t.type)?I.B4_Check:I.B4_Other}},v=class{constructor(e,t){this.form=e,this.resizeObserver=new ResizeObserver(this.onFormResize.bind(this)),this.page=t||e,this.resizeObserver.observe(e),this.updateLayoutOnScroll=this.updateLayoutOnScroll.bind(this),this.page.addEventListener("scroll",this.updateLayoutOnScroll,!0)}clearLayoutHandler(){this.resizeObserver.disconnect(),this.page.removeEventListener("scroll",this.updateLayoutOnScroll,!0),this.layoutHandler=void 0}clipsContentX(e){const{overflow:t,overflowX:i}=e.style;return v.CLIP.includes(t)||v.CLIP.includes(i)}clipsContentY(e){const{overflow:t,overflowY:i}=e.style;return v.CLIP.includes(t)||v.CLIP.includes(i)}getDisplayLabel(e,t){return t?.getAttribute("aria-label")||t?.textContent||e.getAttribute("aria-label")||e.id}getDisplayValue(e,t,i){const n=e.tagName;if(n==="INPUT"){const s=e;return s.type==="checkbox"||s.type==="radio"?s.checked?t:"":s.type==="password"?"*****":String(i)}if(n==="SELECT"){const s=Array.isArray(i)?i:[i];if(!s.length)return String(i);const o=e.options;return typeof s[0]=="number"?s.map(a=>o[a].text).join(`
`):Array.from(o).filter(a=>s.includes(a.value)).map(a=>a.text).join(`
`)}return String(i)}getElements(e){const t=Array.from(this.form.elements);return e.length&&t.push(...Array.from(this.page.querySelectorAll("#"+e.join(",#")))),t}getLabelFor(e){let t=e.id?this.page.querySelector("label[for="+e.id+"]"):void 0;return!t&&e.parentElement?.tagName==="LABEL"&&(t=e.parentElement),!t&&e.previousElementSibling?.tagName==="LABEL"&&(t=e.previousElementSibling),t}getParent(e){return e.parentElement}getPlaceholder(e){return e.getAttribute("placeholder")||""}getRect(e){return(e||this.page).getBoundingClientRect()}getStoreKeys(e){const t=e.getAttribute("name");return t?[t,e.id]:[e.id]}isDisabled(e){if(e.tagName!=="TEXTAREA")return e.disabled;const t=e;return t.disabled||t.readOnly}isHidden(e){return e.hidden}setLayoutHandler(e){this.layoutHandler=e}onFormResize(){this.layoutHandler&&this.layoutHandler.handleLayout()}updateLayoutOnScroll(e){e.target instanceof HTMLElement&&this.layoutHandler&&this.layoutHandler.handleLayout(e.target)}};let L=v;L.CLIP=["auto","hidden","scroll"];class P{constructor(t){if(this.wrapperClass=t,!t)throw new Error("FmmFrameworkItemBase requires wrapperClass")}destructor(){}getEnvelope(t,i,n){let s=i.parentElement;for(;s&&s.tagName!=="FORM"&&!s.classList.contains(this.wrapperClass);)s=s.parentElement;if(s&&s.tagName!=="FORM")return s;if(!!n){for(s=n.parentElement;s&&s.tagName!=="FORM"&&!s.classList.contains(this.wrapperClass);)s=s.parentElement;return s&&s.tagName!=="FORM"?s:void 0}}getError(t,i,n,s){return""}getLabel(t,i){return i.querySelector("LABEL")||i.querySelector("[aria-label]")}getValue(t,i,n,s){return""}}const D=class extends m{constructor(){super(...arguments);this.listener=this.notifyMinimaps.bind(this)}createStoreItem(e,t){const i=t.tagName;if(i==="INPUT"){const n=t;return D.INPUTTYPES.includes(n.type)?new B(n,this.listener):void 0}if(i==="SELECT")return new H(t,this.listener);if(i==="TEXTAREA")return new q(t,this.listener)}getError(e,t,i){return t.fe.validationMessage||t.fe.required&&!t.fe.value&&"Required"||""}getName(e,t){return t.fe.name}getValue(e,t){return t.getValue()}isDisabled(e,t){return e.isDisabled(t.fe)}};let b=D;b.INPUTTYPES=["checkbox","color","date","datetime","datetime-local","email","month","number","password","radio","range","search","tel","text","time","url","week"];class x extends P{constructor(t){super(t)}getError(t,i,n,s){if(!i.classList.contains("is-invalid"))return"";for(let o=i.nextElementSibling;o&&o!==i;o=o.nextElementSibling)if(o.classList.contains("invalid-feedback"))return o.textContent||"";return""}}const I={B4_Check:new x("form-check"),B4_Other:new x("form-group")};class w{constructor(t,i,n){this.fe=t,this.event=i,this.listener=n,t.addEventListener(i,n)}destructor(){this.fe.removeEventListener(this.event,this.listener)}getValue(){return this.fe.value||void 0}isDisabled(){return this.fe.disabled}}class B extends w{constructor(t,i){super(t,"input",i)}}class H extends w{constructor(t,i){super(t,"change",i);this.e=t,this.isMultiple=t.multiple}getValue(){const t=this.e.selectedIndex;if(t<0)return;if(!this.isMultiple)return[t];const i=[],n=this.e.options;for(let s=n.length;--s>=t;)n[s].selected&&i.push(s);return i.reverse()}}class q extends w{constructor(t,i){super(t,"input",i);this.e=t}}class l{static createMinimap(t,i){if(!t.anchor)throw new Error("FmmMinimap not created: invalid anchor");return new E(i).createMinimap({...t,ordinal:0,usePanelDetail:!1})}static createPanel(t,i,n,s,o){const r="FmmPanel not created: invalid ";if(!t)throw new Error(r+"parent");if(i<1||i>20)throw new Error(r+"minimapsCount");return new E(o,i,!!s,t,n)}static trim(t){return t?.trim().replace(/\u200B/g,"")}}l.CLASS=Object.freeze({Detached:"fmm-detached",DetailPopup:"fmm-detail",Disabled:"fmm-disabled",Error:"fmm-error",Fieldset:"fmm-fieldset",Header:"fmm-header",Invalid:"fmm-invalid",Legend:"fmm-legend",MinimapFrame:"fmm-frame",MinimapPopup:"fmm-popup",Optional:"fmm-optional",Pushpin:"fmm-pushpin",Required:"fmm-required",Title:"fmm-title",Valid:"fmm-valid",Value:"fmm-value"}),l.CSS=`
	circle.fmm-pushpin {
		fill: blue;
	}
	div.fmm-detail,
	div.fmm-popup {
		background-color: darkgray;
		border: 1px solid black;
		box-shadow: 5px 5px lightgray;
		padding-top: 10px;
		z-index: 1;
	}
	div.fmm-disabled {
		background-color: darkgray;
	}
	div.fmm-disabled,
	div.fmm-invalid,
	div.fmm-optional,
	div.fmm-required,
	div.fmm-valid {
		border: 1px solid transparent;
	}
	div.fmm-frame {
		background-color: white;
	}
	div.fmm-header {
		border-bottom: 5px groove;
		margin: 0;
	}
	div.fmm-invalid {
		background-color: red;
	}
	div.fmm-optional {
		border-color: black;
	}
	div.fmm-required {
		border-color: red;
	}
	div.fmm-valid {
		background-color: green;
	}
	fieldset.fmm-fieldset {
		background-color: white;
		border-top: 5px groove;
		min-width: 0;
		padding: 5px 10px;
	}
	fieldset.fmm-fieldset div.fmm-disabled,
	fieldset.fmm-fieldset div.fmm-invalid,
	fieldset.fmm-fieldset div.fmm-optional,
	fieldset.fmm-fieldset div.fmm-required,
	fieldset.fmm-fieldset div.fmm-valid {
		border-width: 2px;
	}
	label.fmm-title {
		font-size: smaller;
		padding: 2px;
	}
	legend.fmm-legend {
		background-color: white;
		margin: 5px;
		max-width: 100%;
		padding-right: 5px;
	}
	textarea.fmm-value {
		height: 3em;
		width: 100%;
	}
	div.fmm-detached.fmm-popup,
	div.fmm-detached div.fmm-detail {
		background-color: lightgray;
	}
	div.fmm-detached.fmm-frame,
	div.fmm-detached div.fmm-frame,
	div.fmm-detached fieldset.fmm-fieldset,
	iv.fmm-detached legend.fmm-legend {
		background-color: lightgray !important;
	}
	`,l.STATUS_CLASS=Object.freeze({Disabled:"fmm-disabled",Invalid:"fmm-invalid",Optional:"fmm-optional",Required:"fmm-required",Valid:"fmm-valid"});class X{constructor(t,i,n){this.parent=n,this.clip=n?.clipRect(t.getRect(i))||t.getRect(i),this.clipX=t.clipsContentX(i),this.clipY=t.clipsContentY(i)}clipRect(t){const i=Math.max(t.left,this.clip.left),n=Math.max(t.top,this.clip.top),s=Math.max(0,(this.clipX?Math.min(t.right,this.clip.right):t.right)-i),o=Math.max(0,(this.clipY?Math.min(t.bottom,this.clip.bottom):t.bottom)-n),r={left:i,top:n,width:s,height:o,right:i+s,bottom:n+o};return s&&o&&this.parent?this.parent.clipRect(r):r}}class W{constructor(t,i){this.debounceMsec=t,this.task=i,this._doTask=this.doTask.bind(this),this.notBeforeMsec=0}destructor(){!this.task||(this.timer&&window.clearTimeout(this.timer),this.timer=void 0)}cancel(){return this.timer?(window.clearTimeout(this.timer),this.timer=void 0,!0):!1}doNow(){!this.task||(this.cancel(),this.task())}schedule(){!this.task||(this.notBeforeMsec=Date.now()+this.debounceMsec,this.timer||(this.timer=window.setTimeout(this._doTask,this.debounceMsec)))}doTask(){const t=this.notBeforeMsec-Date.now();t>0?this.timer=window.setTimeout(this._doTask,t):(this.timer=void 0,this.task())}}class M{constructor(t,i){this.data=f.NULLDATA,this.minimapId=0;const n=this.e=t.createElement("FIELDSET");n.className=l.CLASS.Fieldset;const s=c.ELLIPSIS(t.createElement("LEGEND"));s.className=l.CLASS.Legend,this.status=s.appendChild(t.createElement("DIV")),this.status.style.display="inline-block",this.status.style.margin="3px 6px 0 3px",this.status.style.height="0.7em",this.status.style.width="1em",this.label=s.appendChild(t.createElement("SPAN")),this.label.textContent=c.NBSP,n.appendChild(s),this.value=n.appendChild(t.createElement("TEXTAREA")),this.value.className=l.CLASS.Value,this.value.readOnly=!0,this.error=c.ELLIPSIS(n.appendChild(t.createElement("DIV"))),this.error.className=l.CLASS.Error,this.error.textContent=c.NBSP,i&&i.appendChild(n)}destructor(){this.e.parentElement&&this.e.parentElement.removeChild(this.e)}clear(t){t&&t!==this.data||(this.error.textContent=this.label.textContent=c.NBSP,this.status.className=this.value.placeholder=this.value.value="",this.data=f.NULLDATA)}refreshDisplay(t){if(t!==this.minimapId)return;const i=this.data,n=i.aggregateLabel?.concat(": ")||"";this.error.textContent=this.error.title=i.error||c.NBSP,this.label.textContent=this.label.title=n+i.label||c.NBSP,this.status.className=l.STATUS_CLASS[i.status],this.value.placeholder=i.placeholder||"",this.value.value=i.aggregateValues?.join(`
`)||i.value||""}setDisplay(t,i){this.data=i||f.NULLDATA,this.refreshDisplay(this.minimapId=t)}}const k=class{constructor(e,t,i,n){this.e=t,this.storeItem=i;const s=n.form.getLabelFor(t);this.dynamicLabel=n.dynamicLabels.includes(e),this.form=n.form,this.framework=n.framework?.createFrameworkItem(e,t)||k.DEFAULT_FRAMEWORK,this.envelope=this.framework.getEnvelope(e,t,s)||this.getCommonAncestor(t,s)||t,this.label=s||this.framework.getLabel(e,this.envelope),this.snapshot=new f(e,n)}destructor(){this.framework.destructor(),this.storeItem.destructor()}layoutSnapshot(e,t,i){const n=this.form.getParent(this.envelope);if(!n)return this.snapshot.setRect();const o=(e.get(n)||this.getClipContext(n,e)).clipRect(this.form.getRect(this.envelope));if(!o.width||!o.height)return this.snapshot.setRect();const r=Math.floor((o.left-t.left)*i),a=Math.floor((o.top-t.top)*i),h=Math.max(2,Math.floor(o.height*i)),d=Math.max(2,Math.floor(o.width*i));return this.snapshot.setRect(new DOMRectReadOnly(r,a,d,h))}removeIfDetached(){if(this.form.getParent(this.envelope)){for(let e=this.e;e;e=this.form.getParent(e))if(e===this.envelope)return!1}return this.snapshot.destructor(),this.destructor(),!0}takeSnapshot(e,t){const i=this.snapshot.data,n=i.name;(!i.label||this.dynamicLabel)&&(i.label=l.trim(e.getDisplayLabel(this.e,this.label)||n),i.placeholder=l.trim(this.form.getPlaceholder(this.e)));let s=l.trim(this.framework.getValue(n,this.e,this.envelope,i.label));if(!s){const r=t.getValue(e,this.storeItem);r&&(s=l.trim(e.getDisplayValue(this.e,i.label,r)))}i.value=s;const o=!!s;return o&&i.aggregateValues&&i.aggregateValues.push(s),i.error=l.trim(this.framework.getError(n,this.e,this.envelope,o)||t.getError(e,this.storeItem,o)),t.isDisabled(e,this.storeItem)?this.snapshot.setStatus("Disabled"):o?this.snapshot.setStatus(i.error?"Invalid":"Valid"):this.snapshot.setStatus(i.error?"Required":"Optional"),i}getClipContext(e,t){const i=this.form.getParent(e),n=i?t.get(i)||this.getClipContext(i,t):void 0,s=new X(this.form,e,n);return t.set(e,s),s}getCommonAncestor(e,t){const i=[];for(;t;t=this.form.getParent(t))i.push(t);for(;e&&!i.includes(e);)e=this.form.getParent(e);return e}};let A=k;A.DEFAULT_FRAMEWORK={destructor:()=>{},getEnvelope:(e,t,i)=>{},getError:(e,t,i,n)=>"",getLabel:(e,t)=>{},getValue:(e,t,i,n)=>""};const F=class{constructor(){this.list=[],this.ignore=new WeakSet,this.nameCounter=0}destructor(){this.ignore=new WeakSet,this.list.splice(0).forEach(e=>e.destructor())}compose(e){const t=e.form.getElements(e.customElementIds);this.list.splice(0).forEach(s=>s.removeIfDetached()||this.list.push(s));const n=new WeakSet;this.list.forEach(s=>n.add(s.e)),t.forEach(s=>{if(n.has(s)||this.ignore.has(s))return;if(e.form.isHidden(s))return this.ignore.add(s);const o=e.store.createStoreItem(e.form,s);if(o){const r=e.store.getName(e.form,o)||F.NAMEPREFIX+String(this.nameCounter++);this.list.push(new A(r,s,o,e))}n.add(s)})}layoutSnapshots(e,t,i){this.list.forEach(n=>n.layoutSnapshot(e,t,i))}takeSnapshots(e,t){return this.list.map(i=>i.takeSnapshot(e,t))}};let T=F;T.NAMEPREFIX="$FmmFSI";const N=class{constructor(e,t,i,n){this.dragData="";const s=this.div=e.createElement("DIV");s.className=l.CLASS.MinimapFrame,s.draggable=!0,s.ondragstart=this.onDragStart.bind(this),s.style.cursor="grab",s.style.position="relative";const o=this.header=s.appendChild(e.createElement("DIV"));o.className=l.CLASS.Header,o.style.overflow="hidden",o.style.whiteSpace="nowrap";const r=c.ELLIPSIS(e.createElement("LABEL"));r.className=l.CLASS.Title,r.style.cursor="inherit",r.textContent=r.title=i;const a=t.style;if(n){a.position="absolute",a.top=a.bottom=a.left=a.right="0",N.POSITIONS.includes(n.style.position)||(n.style.position="relative"),n.appendChild(t),this.popup=new C(e,l.CLASS.MinimapPopup,this.div,t);let h=t.previousElementSibling;for(;h&&!h.className.includes("fmm-");)h=h.previousElementSibling;h&&n.removeChild(h),this.setDestroyOnDetachFromDOM(n,t)}else o.appendChild(t),a.display="inline-block",a.margin="1px 2px 0 1px",a.height="0.5em",a.width="0.8em";o.appendChild(r)}destructor(){!this.div.parentElement||(this.detach(),this.popup&&this.popup.destructor(),this.popup=void 0,this.div.onmouseenter=this.div.onmouseleave=null,this.div.parentElement?.removeChild(this.div))}detach(){this.popup?this.div.parentElement?.classList.add(l.CLASS.Detached):this.div.classList.add(l.CLASS.Detached)}newDetailPopup(e,t){return new C(e,l.CLASS.DetailPopup,t.e,this.div)}setSnapshotResult(e){this.dragData=JSON.stringify(e)}onDragStart(e){e.dataTransfer?.setData("text/plain",this.dragData)}setDestroyOnDetachFromDOM(e,t){new MutationObserver((i,n)=>{t.parentElement!==e&&(n.disconnect(),this.destructor())}).observe(e,{childList:!0})}};let _=N;_.POSITIONS=["absolute","fixed","relative","sticky"];const c={ELLIPSIS:e=>(e.style.overflow="hidden",e.style.textOverflow="ellipsis",e.style.whiteSpace="nowrap",e),NBSP:"\xA0",NOP:()=>{}},S=class{constructor(e,t){this.onUpdateBeingCalled=!1,this.pendingCompose=!1,this.pendingLayout=!1,this.pendingSnapshot=!1;const i=t.ef,n=i.createElement("DIV");this.ordinal=e.ordinal||0,this.summaryData={...f.NULLDATA,label:e.title},this.title=e.title;const s=new _(i,n,this.title,e.anchor);t.add(this,e.anchor?void 0:s.div),s.div.onmouseenter=this.onFrameEnter.bind(this),s.div.onmouseleave=this.onFrameLeave.bind(this),e.anchor&&e.zoomFactor&&s.popup&&s.popup.setZoomable(this,s.header,Math.min(S.MAX_ZOOMFACTOR,Math.max(0,e.zoomFactor))),s.header.onmouseenter=this.onHeaderEnter.bind(this);const o=new Y(i,s.div);this.minimapId=S.idCounter++,this.useWidthToScale=!!e.useWidthToScale,this.verbosity=e.verbosity||0,this.d={clipContextAncestors:new WeakMap,doUpdates:new W(e.debounceMsec||S.DEFAULT_DEBOUNCEMSEC,()=>this.doPendingUpdates()),onUpdate:e.onUpdate||S.ONUPDATE,paramUpdates:{aggregateLabels:e.aggregateLabels||{},aggregateValuesMap:{},customElementIds:[],dynamicLabels:e.dynamicLabels||[],ef:t.ef,form:e.form,framework:e.framework,snapshotUpcall:{hideDetail:this.snapshotHidden.bind(this),showDetail:this.snapshotActive.bind(this)},snapshotsPanel:o,store:e.store||new b},storeItems:new T};const r=e.usePanelDetail&&t.detail||new M(i);this.z={detail:r,detailPopup:r===t.detail?void 0:e.anchor?s.newDetailPopup(i,r):t.newDetailPopup(r),frame:s,panel:t,pin:new Z(i,s.div),snapshotsPanel:o,status:n},e.anchor&&(n.onmouseover=this.onStatusEnter.bind(this)),this.d.paramUpdates.store.notifyMinimapOnUpdate(this,!0),this.d.paramUpdates.form.setLayoutHandler(this)}static ONUPDATE(e){}destructor(){this.detach();const e=this.z;!e||(this.z=void 0,e.status.parentElement?.removeChild(e.status),e.snapshotsPanel.destructor(),e.pin.destructor(),e.frame.destructor(),e.detail.clear(this.activeSnapshot),e.detail!==e.panel.detail&&e.detail.destructor(),e.detailPopup&&e.detailPopup.destructor(),e.panel.remove(this))}compose(e){!this.d||(this.d.paramUpdates.customElementIds=e||[],this.pendingCompose=this.pendingLayout=!0,this.takeSnapshot())}get isDetached(){return this.d===void 0}get isPinned(){return this.z?.pin.isPinned}get isPinnedToPanelDetail(){return this.isPinned&&this.z?.detail===this.z?.panel.detail}detach(){const e=this.d,t=this.z;!e||!t||(this.d=void 0,e.doUpdates.destructor(),this.pendingCompose=this.pendingLayout=!1,this.pendingSnapshot=!0,this.doPendingUpdates(),t.frame.detach(),e.paramUpdates.form.clearLayoutHandler(),e.paramUpdates.store.notifyMinimapOnUpdate(this,!1),e.storeItems.destructor())}handleLayout(e){(!e||this.d?.clipContextAncestors.has(e))&&(this.pendingLayout=!0,this.d?.doUpdates.schedule())}layout(e){const t=this.d,i=this.z;if(!t||!i)return;const n=e&&this.verbosity?Date.now():0,s=t.paramUpdates.form.getRect();if(s?.height&&s.width){t.clipContextAncestors=new WeakMap;const o=i.snapshotsPanel.computeScale(s,i.frame,this.useWidthToScale);i.snapshotsPanel.show(!1),t.storeItems.layoutSnapshots(t.clipContextAncestors,s,o),i.snapshotsPanel.show(!0),e&&(i.pin.trackOff(i.frame),i.pin.trackOn(i.snapshotsPanel,e))}e&&this.verbosity&&console.log("FormMinimap["+this.title+"] Layout(ms)="+String(Date.now()-n))}notifyMinimap(e,t){}onFrameEnter(e){const t=this.z;!t||(this.isPinned||t.pin.trackOn(t.snapshotsPanel,e),this.activeSnapshot&&t.detail.setDisplay(this.minimapId,this.activeSnapshot),this.showPopups())}onFrameLeave(){const e=this.z;!e||this.isPinned||(e.pin.trackOff(e.frame),e.detail.clear(this.activeSnapshot),e.detailPopup?e.detailPopup.hide():e.panel.hideDetailPopup(),e.frame.popup&&e.frame.popup.hide())}onHeaderEnter(e){e.stopPropagation(),!(!this.z||this.isPinned)&&(this.activeSnapshot=void 0,this.z.detail.setDisplay(this.minimapId,this.summaryData))}onStatusEnter(e){e.stopPropagation(),this.z?.frame.popup?.isShowing||this.showPopups()}takeSnapshot(){return this.d?(this.pendingSnapshot=!0,this.d.doUpdates.schedule(),!0):!1}doTakeSnapshot(){const e=this.d,t=this.z;if(!e||!t)return{snapshots:[],status:"Disabled",title:this.title};const i=e.paramUpdates,n=Object.values(i.aggregateValuesMap);n.forEach(a=>a.splice(0));const s=e.storeItems.takeSnapshots(i.form,i.store);n.forEach(a=>a.sort());const o=t.snapshotsPanel.computeStatus();t.status.className=l.STATUS_CLASS[o];const r={};return o!=="Disabled"&&s.filter(a=>a.error&&a.status===o).forEach(a=>r[a.aggregateLabel||a.label]=a.error),this.summaryData.aggregateValues=Object.keys(r).sort().map(a=>a+": "+r[a]),this.summaryData.status=o,{snapshots:s,status:o,title:this.title}}doPendingUpdates(){const e=this.d,t=this.z;if(!e||!t)return;const i=this.verbosity?Date.now():0;this.pendingCompose&&e.storeItems.compose(e.paramUpdates);const n=this.verbosity?Date.now():0;this.pendingLayout&&this.layout();const s=this.verbosity?Date.now():0;let o=s;if(this.pendingSnapshot){const r=this.doTakeSnapshot();t.frame.setSnapshotResult(r),this.verbosity&&(o=Date.now()),t.detail.refreshDisplay(this.minimapId),this.onUpdateBeingCalled||(this.onUpdateBeingCalled=!0,e.onUpdate(r),this.onUpdateBeingCalled=!1)}if(this.verbosity){const r=this.pendingCompose?" Compose(ms)="+String(n-i):"",a=this.pendingLayout?" Layout(ms)="+String(s-n):"",h=this.pendingSnapshot?" Snapshot(ms)="+String(o-s):"";(r||a||h)&&console.log("FormMinimap["+this.title+"]"+r+a+h)}this.pendingCompose=this.pendingLayout=this.pendingSnapshot=!1}showPopups(){const e=this.z;!e||(this.d&&this.d.doUpdates.doNow(),e.frame.popup&&e.frame.popup.show(!0),e.detailPopup?e.detailPopup.show(!1):e.panel.showDetailPopup())}snapshotActive(e){this.isPinned||this.z?.detail.setDisplay(this.minimapId,this.activeSnapshot=e)}snapshotHidden(e,t){const i=this.z;!i||(this.activeSnapshot===t&&(this.activeSnapshot=void 0),i.detail.clear(t),i.pin.trackOff(i.frame,e))}};let y=S;y.DEFAULT_DEBOUNCEMSEC=200,y.MAX_ZOOMFACTOR=5,y.idCounter=0;const O=class{constructor(e=O.EF,t=1,i=!1,n,s){if(this.ef=e,this.minimapsCount=t,this.vertical=i,this.minimaps=[],n){this.detail=new M(this.ef,s),this.popupParent=n.appendChild(this.ef.createElement("DIV"));const o=this.popupParent.style;o.position="relative",s||(this.detailPopup=this.newDetailPopup(this.detail)),this.div=n.appendChild(this.ef.createElement("DIV")),this.div.style.height=this.div.style.width="100%",this.div.style.overflow="hidden",this.div.style.position="relative"}}destructor(){this.detail&&this.detail.destructor(),this.detailPopup&&this.detailPopup.destructor(),this.minimaps.splice(0).forEach(e=>e.destructor())}add(e,t){if(t&&this.div){this.div.appendChild(t),t.style.position="absolute";const i=100/this.minimapsCount;this.vertical?(t.style.top=String(e.ordinal*i)+"%",t.style.height=String(i*.9)+"%",t.style.right=t.style.left="0"):(t.style.left=String(e.ordinal*i)+"%",t.style.width=String(i*.9)+"%",t.style.top=t.style.bottom="0")}this.minimaps[e.ordinal]&&this.minimaps[e.ordinal].destructor(),this.minimaps[e.ordinal]=e}createMinimap(e){const t="FmmMinimap <"+e.title+"> not created: invalid ";if(!e.form)throw new Error(t+"form");if(e.ordinal&&e.ordinal>=this.minimapsCount)throw new Error(t+"ordinal");return new y(e,this)}destroyDetached(){this.minimaps.filter(e=>e.isDetached).forEach(e=>e.destructor())}hideDetailPopup(){this.detailPopup&&!this.minimaps.find(e=>e.isPinnedToPanelDetail)&&this.detailPopup.hide()}newDetailPopup(e){return this.popupParent?new C(this.ef,l.CLASS.DetailPopup,e.e,this.popupParent):void 0}remove(e){delete this.minimaps[e.ordinal]}showDetailPopup(){this.detailPopup&&this.detailPopup.show(!1)}};let E=O;E.EF={createElement:e=>document.createElement(e),createElementNS:(e,t)=>document.createElementNS(e,t)};class C{constructor(t,i,n,s){this.div=s.appendChild(t.createElement("DIV")),this.div.className=i,this.div.style.display="none",this.div.style.position="absolute",this.div.appendChild(n),s.style.overflow="visible",n.style.display="block",n.style.position="relative"}destructor(){this.div.parentElement&&this.div.parentElement.removeChild(this.div)}get isShowing(){return this.div.style.display!=="none"}getElementSize(t){const i=this.div.style;if(i.display!=="none"){const o=this.div.getBoundingClientRect(),r=t.getBoundingClientRect();return[o.height-(r.top-o.top),o.width-(r.left-o.left)]}i.visibility="hidden",i.display="block";const n=this.div.getBoundingClientRect(),s=t.getBoundingClientRect();return i.display="none",i.visibility="visible",[n.height-(s.top-n.top),n.width-(s.left-n.left)]}hide(){this.div.style.display="none"}setZoomable(t,i,n){let s=!1,o=0,r=0;i.style.cursor="zoom-in",i.onclick=a=>{if(a.button===0){if(a.stopPropagation(),!o){const h=this.div.getBoundingClientRect();o=h.height,r=h.width}t.useWidthToScale?this.div.style.width=String(s?r:r*n)+"px":this.div.style.height=String(s?o:o*n)+"px",t.layout(a),s=!s,i.style.cursor=s?"zoom-out":"zoom-in"}}}show(t){const i=Math.max(document.documentElement.clientHeight,window.innerHeight||0),n=Math.max(document.documentElement.clientWidth,window.innerWidth||0),s=this.div.style;if(s.display!=="none")return;s.left=s.bottom="auto",s.right=t?"50%":"105%",s.top=t?"50%":"0",s.visibility="hidden",s.display="block";const o=this.div.getBoundingClientRect();if(o.left<0){s.left=t?"50%":"105%",s.right="auto";const r=this.div.getBoundingClientRect();n-r.left-r.width<o.left&&(s.left="auto",s.right=t?"50%":"105%")}if(o.bottom>i){s.bottom=t?"50%":"0",s.top="auto";const r=this.div.getBoundingClientRect();r.top+r.height-i>o.bottom&&(s.bottom="auto",s.top=t?"50%":"0")}s.visibility="visible"}}class Z{constructor(t,i){this.SIZE=24,this.parentCursor="none",this.pinned=!1;const n="http://www.w3.org/2000/svg",s=i.appendChild(t.createElementNS(n,"svg"));this.svg=s,i.style.overflow="visible",s.setAttribute("height",String(this.SIZE)),s.setAttribute("width",String(this.SIZE));const o=this.SIZE/4,r=s.appendChild(t.createElementNS(n,"circle"));r.setAttribute("class",l.CLASS.Pushpin),r.setAttribute("cx",String(this.SIZE-o)),r.setAttribute("cy",String(o)),r.setAttribute("r",String(o));const a=s.appendChild(t.createElementNS(n,"polygon"));[[this.SIZE/2+1,Math.ceil(o*1.5)],[0,this.SIZE],[Math.ceil(this.SIZE*.6),o*2-1]].forEach(([h,d])=>{const u=this.svg.createSVGPoint();u.x=h,u.y=d,a.points.appendItem(u)}),a.setAttribute("style","fill:black"),s.style.display="none",s.style.position="absolute"}destructor(){this.trackOff()}get isPinned(){return this.pinned}trackOff(t,i){const n=this.svg.parentNode;i&&i!==n||(this.pinned=!1,this.svg.style.display="none",n.onclick=n.onmousemove=null,n.style.cursor=this.parentCursor,t?t.div.appendChild(this.svg):n.removeChild(this.svg))}trackOn(t,i){const n=this.svg.parentNode,s=n.getBoundingClientRect();n.appendChild(this.svg),this.parentCursor=n.style.cursor,this.svg.style.zIndex=String(+n.style.zIndex+1),n.onclick=o=>{if(o.button===0)if(this.pinned)this.pinned=!1,n.style.cursor="none",n.appendChild(this.svg),this.move(o,s);else{if(this.pinned=!0,n.style.cursor=this.parentCursor,t.reparentPushPinToSnapshot(this.svg,o))return;const r=Math.max(1,(o.clientX-s.left)*100/s.width);this.svg.style.left=String(r)+"%";const a=Math.min(95,(s.top+s.height-o.clientY)*100/s.height);this.svg.style.bottom=String(a)+"%"}},n.onmousemove=o=>this.move(o,s),this.move(i,s),n.style.cursor="none",this.svg.style.display="block"}move(t,i){if(this.pinned)return;const n=t.clientX-i.left,s=i.top+i.height-t.clientY;this.svg.style.left=String(Math.min(i.width,Math.max(n,0)))+"px",this.svg.style.bottom=String(Math.min(i.height,Math.max(s,0)))+"px"}}const U=class{constructor(e,t){const i=t.aggregateLabels[e];i&&!(e in t.aggregateValuesMap)&&(t.aggregateValuesMap[e]=[]),this.data={...U.NULLDATA,aggregateLabel:i,aggregateValues:t.aggregateValuesMap[e],name:e},this.upcall=t.snapshotUpcall,this.div=t.ef.createElement("DIV"),this.div.style.position="absolute",this.div.onmouseover=n=>{n.stopPropagation(),this.upcall.showDetail(this.data)},t.snapshotsPanel.addSnapshot(this,this.div),this.destructor=()=>{this.div.onmouseover=null,this.upcall.hideDetail(this.div,this.data),t.snapshotsPanel.removeSnapshot(this,this.div),this.destructor=c.NOP}}destructor(){}reparentPushPin(e,t,i){const n=this.rect;return!n||t<n.left||t>n.left+n.width||i<n.top||i>n.top+n.height?!1:(this.div.appendChild(e),e.style.left=String((t-n.left)*100/n.width)+"%",e.style.bottom=String((n.top+n.height-i)*100/n.height)+"%",!0)}setRect(e){if(this.rect&&e&&this.rect.left===e.left&&this.rect.top===e.top&&this.rect.right===e.right&&this.rect.bottom===e.bottom)return;this.rect=e;const t=this.div.style;return e?(t.left=String(e.left)+"px",t.top=String(e.top)+"px",t.height=String(e.height)+"px",t.width=String(e.width)+"px",t.display="block"):(this.upcall.hideDetail(this.div,this.data),t.display="none")}setStatus(e){this.div.className=l.STATUS_CLASS[this.data.status=e]}};let f=U;f.NULLDATA={aggregateLabel:"",aggregateValues:void 0,error:"",label:"",name:"",placeholder:"",status:"Optional",value:""};class Y{constructor(t,i){this.list=[],this.div=i.appendChild(t.createElement("DIV")),this.div.style.position="relative"}destructor(){this.div.parentElement&&this.div.parentElement.removeChild(this.div),this.list.splice(0).forEach(t=>t.destructor())}addSnapshot(t,i){this.list.push(t),this.div.appendChild(i)}computeScale(t,i,n){if(!this.div.parentElement)return 0;const[s,o]=i.popup?i.popup.getElementSize(this.div):this.getSize(),r=s/t.height,a=o/t.width,h=this.div.parentElement.style,d=this.div.style;if(i.popup||(n=t.height*a<=s),n){const g=String(Math.round(t.height*a))+"px";if(h.width=d.width=String(o)+"px",d.height=g,d.height===g)return a}else{const g=String(Math.round(t.width*r))+"px";if(d.height=String(s)+"px",h.width=d.width=g,h.width===g&&d.width===g)return r}const u=Math.min(r,a);return d.height=String(Math.round(t.height*u))+"px",h.width=d.width=String(Math.round(t.width*u))+"px",u}computeStatus(){let t="Disabled",i,n;const s=this.list;for(let o=s.length;--o>=0;){const r=s[o].data.status;if(r==="Invalid")return r;r!=="Disabled"&&(t=void 0),r==="Required"&&(i=r),r==="Valid"&&(n=r)}return i||t||n||"Optional"}removeSnapshot(t,i){const n=this.list.findIndex(s=>s===t);n<0||(this.list.splice(n,1),this.div.removeChild(i))}reparentPushPinToSnapshot(t,i){const n=this.div.getBoundingClientRect(),s=i.clientX-n.left,o=i.clientY-n.top;return!!this.list.find(r=>r.reparentPushPin(t,s,o))}show(t){this.div.style.display=t?"block":"none"}getSize(){const t=this.div.getBoundingClientRect();if(!this.div.parentElement)return[t.height,t.width];const i=this.div.parentElement.getBoundingClientRect();return[i.height-(t.top-i.top),i.width-(t.left-i.left)]}}p.Fmm=l,p.FmmBootstrap4=V,p.FmmFormHTML=L,p.FmmFrameworkItemHTML=P,p.FmmStoreBase=m,p.FmmStoreHTML=b,p.FmmStoreImpl=R});
